# 데이터 가공하기

> - `MS SQL`에서 string 문자를 입력할 때는 " 대신 '를 사용
> - `MS SQL`은 정규 표현식을 사용하여 원하는 문자열 추출하는 것이 여타 DB보다 어려움(PostgreSQL, Oracle, BigQuery, etc.)

## 1. 코드 값을 레이블로 변경하기

- 원 데이터 `mst_users`는 아래와 같음

  | user_id | register_date | register_device |
  | ------- | ------------- | --------------- |
  | U001    | 2016-08-26    | 1               |
  | U002    | 2016-08-26    | 2               |
  | U003    | 2016-08-27    | 3               |

- 이는 회원 등록 때 사용한 장치를 저장하는 칼럼 `register_device`가 코드 값으로 저장되어 있기 때문

- 업무시에는 편하지만, 리포트의 가독성이 낮아지므로, `CASE`문을 활용하여 코드 값을 레이블로 변경

- 이때 사용할 쿼리문은 아래와 같음:

  ```mssql
  SELECT
  	user_id,
  	CASE
  	WHEN register_device=1 THEN '데스크탑'
  	WHEN register_device=2 THEN '스마트폰'
  	WHEN register_device=3 THEN '어플리케이션'
  	END AS device_name
  FROM mst_users;
  ```

- 결과물은 아래와 같음:

  | user_id | register_device |
  | ------- | --------------- |
  | U001    | 데스크탑        |
  | U002    | 스마트폰        |
  | U003    | 어플리케이션    |


___

## 2. URL에서 요소 추출하기

- 원 데이터 `access_log`는 다음과 같음:

  | stamp               | referrer                                              | url                                        |
  | ------------------- | ----------------------------------------------------- | ------------------------------------------ |
  | 2016-08-26 12:02:00 | http://www.other.com/path1/index.php?k1=v1&k2=v2#Ref1 | http://www.example.com/video/detail?id=001 |
  | 2016-08-26 12:02:01 | http://www.other.net/path1/index.php?k1=v1&k2=v2#Ref1 | http://www.example.com/video#ref           |
  | 2016-08-26 12:02:01 | https://www.other.com/                                | http://www.example.com/book/detail?id=002  |

- 웹사이트에서 어떤 웹 페이지를 거쳐 넘어왔는지 판별할고 집계할 때, 페이지 단위로 집계하는 것 보다는 호스트 단위로 하는 것이 일반적

- a) 이때 정규표현식을 사용하여 호스트 값만 추출 가능(아래 예제는 `PostgreSQL` 버전 Query): 

  ```mssql
  SELECT
  	stamp,
  	substring(referrer from 'https?://([^/]*)') AS referrer_host
  FROM access_log;
  ```

- 결과는 다음과 같음:

  | stamp               | referrer_host |
  | ------------------- | ------------- |
  | 2016-08-26 12:02:00 | www.other.com |
  | 2016-08-26 12:02:01 | www.other.net |
  | 2016-08-26 12:02:01 | www.other.com |

- b) 경로와 요청 매개변수를 추출하기 위해서는 아래 쿼리를 활용(`PostgreSQL` 버전):

  ```mssql
  SELECT
  	stamp,
  	url,
  	substring(url from '//[^/]+[^?#]+)') AS path,
  	substring(url from 'id=([^&]*)') AS id
  FROM access_log;
  ```

- 결과는 다음과 같음:

  | stamp               | url                                        | path          | id   |
  | ------------------- | ------------------------------------------ | ------------- | ---- |
  | 2016-08-26 12:02:00 | http://www.example.com/video/detail?id=001 | /video/detail | 001  |
  | 2016-08-26 12:02:01 | http://www.example.com/video#ref           | /video        |      |
  | 2016-08-26 12:02:01 | http://www.example.com/video/detail?id=002 | /video/detail | 002  |

___

## 3. 문자열을 배열로 분해하기

c

