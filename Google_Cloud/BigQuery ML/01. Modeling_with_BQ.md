## Modeling with BQ

**211203 현 시점에 BQ에서 사용가능한 모델은 linear_reg와 logistic_reg 두가지 뿐임**

### 학습

- BigQuery에서 모델링을 수행하는 기본 syntax는 다음과 같음:

  ```sql
  #standardSQL
  CREATE OR REPLACE MODEL `bqml_lab.sample_model`
  OPTIONS(model_type='logistic_reg') AS
  SELECT
    IF(totals.transactions IS NULL, 0, 1) AS label,
    IFNULL(device.operatingSystem, "") AS os,
    device.isMobile AS is_mobile,
    IFNULL(geoNetwork.country, "") AS country,
    IFNULL(totals.pageviews, 0) AS pageviews
  FROM
    `bigquery-public-data.google_analytics_sample.ga_sessions_*`
  WHERE
    _TABLE_SUFFIX BETWEEN '20160801' AND '20170631'
  LIMIT 100000;
  ```
- 학습 부분만 떼어 보면 다음과 같음:
  ```sql
  CREATE OR REPLACE MODEL `ecommerce.classification_model`
  OPTIONS
  (
  model_type='logistic_reg',
  labels = ['will_buy_on_return_visit']
  )
  AS
  #standardSQL
  ```
  
- `CREATE MODEL {모델명}`이나 `REPLACE MODEL {모델명}`으로 모델을 생성하고;
  `OPTIONS(model_type={모델타입}, labels={optional})`으로 사용할 모델과 y label을 지정하고
  `SELECT`문으로 feature를 지정해 주는 방식으로 구성됨

-  위와 같이 SQL문을 작성한 후 RUN 수행 시 fitting이 진행됨

-  학습 결과는 `bqml_lab.sample_model`의 Training으로 이동하면 학습 결과를 확인할 수 있음



### 평가

- BigQuery에서 만들어진 모델링을 평가할 때에는 `ml.EVALUATE(MODEL {모델명}, ....)`을 사용하게 됨:

  ```sql
  #standardSQL
  SELECT
    *
  FROM
    ml.EVALUATE(MODEL `bqml_lab.sample_model`, (
  SELECT
    IF(totals.transactions IS NULL, 0, 1) AS label,
    IFNULL(device.operatingSystem, "") AS os,
    device.isMobile AS is_mobile,
    IFNULL(geoNetwork.country, "") AS country,
    IFNULL(totals.pageviews, 0) AS pageviews
  FROM
    `bigquery-public-data.google_analytics_sample.ga_sessions_*`
  WHERE
    _TABLE_SUFFIX BETWEEN '20170701' AND '20170801'));
  ```

  

- 이 때 결과 값은 precisoin, recall, accuracy, f1_score, log_loss, roc_auc 를 반환



### 사용

- 만들어진 모델을 사용할 때에는 `ml.PREDICT(MODEL {모델명}, ...)`을 사용:

  ```sql
  #standardSQL
  SELECT
    country,
    SUM(predicted_label) as total_predicted_purchases
  FROM
    ml.PREDICT(MODEL `bqml_lab.sample_model`, (
  SELECT
    IFNULL(device.operatingSystem, "") AS os,
    device.isMobile AS is_mobile,
    IFNULL(totals.pageviews, 0) AS pageviews,
    IFNULL(geoNetwork.country, "") AS country
  FROM
    `bigquery-public-data.google_analytics_sample.ga_sessions_*`
  WHERE
    _TABLE_SUFFIX BETWEEN '20170701' AND '20170801'))
  GROUP BY country
  ORDER BY total_predicted_purchases DESC
  LIMIT 10;
  ```

- 이 떄 아래와 같이 변형된 형태로 사용할 수도 있음:

  ```sql
  #standardSQL
  SELECT
    fullVisitorId,
    SUM(predicted_label) as total_predicted_purchases
  FROM
    ml.PREDICT(MODEL `bqml_lab.sample_model`, (
  SELECT
    IFNULL(device.operatingSystem, "") AS os,
    device.isMobile AS is_mobile,
    IFNULL(totals.pageviews, 0) AS pageviews,
    IFNULL(geoNetwork.country, "") AS country,
    fullVisitorId
  FROM
    `bigquery-public-data.google_analytics_sample.ga_sessions_*`
  WHERE
    _TABLE_SUFFIX BETWEEN '20170701' AND '20170801'))
  GROUP BY fullVisitorId
  ORDER BY total_predicted_purchases DESC
  LIMIT 10;
  ```

  
